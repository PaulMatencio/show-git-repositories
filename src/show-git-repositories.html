<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="icon-toggle.html">
<link rel="import" href="show-git-shared-styles.html">

<dom-module id="show-git-repositories">
    <template>
        <!-- Styles MUST be inside template -->
      <style include="show-git-shared-styles">
        :host {
            display: block;
            padding : 15px;
        }

        .command {
          display: inline-flex;
          width: 100%;
        }

        #filter {
          margin-left: 20%;
        }

        .list {
          margin-left : 20%;
          margin-right: 20%;
        }

        a {
          display: block;
          margin-bottom: 10px;
        }

        li {
          list-style: none;
        }

        .hidden {
          display: none;
        }

      </style>

      <dom-bind>
      <div class="command list">
        <iron-input  id="user" bind-value="{{user}}">
          <input type="text" value="{{user::input}}">
        </iron-input>
        <iron-icon class="icon" icon="search" on-click="_fire" ></iron-icon>
        <iron-input  id="filter"  bind-value="{{filter}}">
          <input type="text" placeholder= "filter name" value="{{filter::input}}">
        </iron-input>
      </div>
      <div>
        <p class= "card list"> <strong> The total number of [[user]] 's Github repositories is [[numberRepos]]</strong></p>
      </div>
      </dom-bind>

      <div class="list">
      <template is="dom-repeat" items="[[repos]]">
          <ul  id="repos" class="card">
               <li> <strong>Name: [[item.name]] </strong></li>
               <li> Description: [[item.description]] </li>
               <li><a href="[[item.html_url]]"> Url: [[item.html_url]] </a> <li>
               <li> Created at: [[item.created_at]]  </li>
               <li> Has pages: [[item.has_pages]]  </li>
          </ul>
      </template>
    </div>

      <!--iron-list items="[[data]]" as="item" scroll-target="document">
        <template>
          <div>
            <div class="item" tabindex$="[[tabIndex]]">
              <iron-image class="avatar" sizing="contain" src="[[item.image]]"></iron-image>
              <div class="pad">
                <input type="text" name="value">
                <div class="primary">[[item.name]] [[index]]</div>
                <div> <a href="#">Link 1</a> <a href="#">Link 2</a> <a href="#">Link 3</a> <a href="#">Link 4</a> </div>
                <div class="secondary">[[item.shortText]]</div>
                <div class="secondary dim">[[item.longText]]</div>
              </div>
            </div>
          </div>
        </template>
      </iron-list-->

        <!-- url="https://api.github.com/users/burczu/repos" -->
        <!--
        If verbode true, error messages will automatically
        be logged to the console.


        With auto set to true, the element performs a request whenever its url,
        params or body properties are changed.

        headers='{"X-Requested-With": "XMLHttpRequest"}'
        on-response="_handleResponse"
        last-response= {{ajaxResponse}}
        -->
      <iron-ajax
            verbose
            id="requestRepos"
            url="[[url]]"
            params='{"type":"all"}'
            handle-as="json"
            on-response="_handleResponse"
            lastError = "{{lastError}}"
            on-error = "_handleError"
            iron-ajax-error = "_handleError"
            debounce-duration="300">
      </iron-ajax>
    </template>

    <script>
    class ShowGitRepositories extends Polymer.Element {
        static get is()  { return 'show-git-repositories' }
        static get properties() {
          return {
            repos: {
              type: Array,
              value: [],
              notify: true,
              reflectToAttribute: true
            },

            user: {
              type: String,
              value: "PaulMatencio",
              notify: true,
              reflectToAttribute: true,
              observer: "_user"
            },

            filter: {
              type: String,
              value: "",
              notify: true,
              reflectToAttribute: true,
              observer: "_filter"
            },

            url: {
              type: String,
              value: function() {
                return ("https://api.github.com/users/" + this.user + "/repos")
              },
              reflectToAttribute: true
            },

            sortBy: {
              type: String,
              value: "",
              notify: true,
              reflectToAttribute: true
            },

            numberRepos: {
              type: Number,
              computed : '_computedLength(repos)',
              reflectToAttribute: true
            }
          }
        }

        constructor() {
          super();
        }

        ready() {
          super.ready();
          /**
           * You can trigger a request explicitly by calling generateRequest on the element.
           */
          this.$.requestRepos.generateRequest();
        }

        _handleResponse(event)  {
            const req = event.detail; // iron-request
            console.log('status', req.status, req.statusText);
            if (req.status == 200 ) {
              this.repos = event.detail.response;
              console.log(this.repos);
            }
         }

        _handleErrort(request, erorr)  {
          console.log(request,error);
        }

        /**  Obsever  of the user input element
          *
         */
        _user() {
            /* this.setProperties({url: 'xxxxxxx', user: xxxx }); */
            this.url =  "https://api.github.com/users/" + this.user + "/repos";
        }

        /**  Obsever  of the filter input element
          *
         */
        _filter() {
            var reposa = this.shadowRoot.querySelectorAll("#repos");
            if (reposa == undefined) {return} ;
            var filter = this.filter.toLowerCase();
            reposa.forEach(function(repos,index)  {
              // use array this.repos.name to filter
              name = this.repos[index].name.toLowerCase() ;
              console.log(name,filter);
              if ( name.indexOf(filter) < 0 ) {
                    repos.classList.add("hidden") ;
              } else {
                repos.classList.remove("hidden") ;
              }
            },this);
         }

        _fire() {
            this.repos = [];
            this.$.requestRepos.generateRequest();
        }

        _click() {
           console.log(this.$);
        }

        _computedLength(repos) {
          return repos.length ;
        }
      }

      // Register custom element definition using standard platform API
      customElements.define(ShowGitRepositories.is, ShowGitRepositories);
    </script>

</dom-module>
